
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ä¿®æ”¹å®‰å…¨å¯†ç </title>
  <link rel="stylesheet" href="style_password.css" />
</head>
<body>
  <div class="container">
    <div class="box">
      <input type="password" id="old" placeholder="åŸå§‹å¯†ç " maxlength="4" />
      <input type="password" id="new1" placeholder="æ–°å¯†ç " maxlength="4" />
      <input type="password" id="new2" placeholder="ç¡®è®¤å¯†ç " maxlength="4" />
      <button onclick="modifyPassword()">ä¸‹ä¸€æ­¥</button>
    </div>
  </div>

<script>
  function getTelegramUserId() {
    try {
      return window.Telegram?.WebApp?.initDataUnsafe?.user?.id || "anonymous";
    } catch (e) {
      return "anonymous";
    }
  }

  function modifyPassword() {
    const userId = getTelegramUserId();
    const oldpwd = document.getElementById("old").value;
    const newpwd1 = document.getElementById("new1").value;
    const newpwd2 = document.getElementById("new2").value;

    const stored = sessionStorage.getItem("userPassword_" + userId) || localStorage.getItem("userPassword_" + userId);
    console.log("å½“å‰å­˜å‚¨å¯†ç  =", stored, "è¾“å…¥çš„æ—§å¯†ç  =", oldpwd);

    if (!stored || oldpwd !== stored) {
      alert("ğŸš« åŸå§‹å¯†ç é”™è¯¯ï¼");
      return;
    }

    if (!/^[0-9]{4}$/.test(newpwd1)) {
      alert("âš ï¸ æ–°å¯†ç å¿…é¡»æ˜¯4ä½æ•°å­—");
      return;
    }

    if (newpwd1 !== newpwd2) {
      alert("ğŸš« æ–°å¯†ç ä¸ç¡®è®¤å¯†ç ä¸ä¸€è‡´");
      return;
    }

    localStorage.setItem("userPassword_" + userId, newpwd1);
    sessionStorage.setItem("userPassword_" + userId, newpwd1);
    alert("âœ… å¯†ç ä¿®æ”¹æˆåŠŸï¼");
    window.location.href = "password_success.html";
  }
</script>
</body>
</html>

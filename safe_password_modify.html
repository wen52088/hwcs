
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>修改安全密码</title>
  <link rel="stylesheet" href="style_password.css" />
</head>
<body>
  <div class="container">
    <div class="white-box">
      <h2 class="box-title">修改安全密码</h2>
      <input id="old" maxlength="4" inputmode="numeric" pattern="[0-9]*" class="input-box" placeholder="请输入原始安全密码" />
      <input id="new" maxlength="4" inputmode="numeric" pattern="[0-9]*" class="input-box" placeholder="请输入新密码（4位数字）" />
      <input id="confirm" maxlength="4" inputmode="numeric" pattern="[0-9]*" class="input-box" placeholder="再次输入新密码" />
    </div>
    <button class="next-btn" onclick="handleSubmit()">下一步</button>
  </div>
  <script>
    const tg = window.Telegram.WebApp || {};
    const userId = tg.initDataUnsafe?.user?.id || 'debug_user';
    const passwordKey = 'userPassword_' + userId;
    const errorCountKey = 'passwordErrorCount_' + userId;

    function handleSubmit() {
      const oldpwd = document.getElementById('old').value.trim();
      const newpwd = document.getElementById('new').value.trim();
      const confirm = document.getElementById('confirm').value.trim();

      const stored = sessionStorage.getItem(passwordKey);
      const errorCount = parseInt(sessionStorage.getItem(errorCountKey) || '0');

      console.log('用户ID:', userId);
      console.log('会话存储密码:', stored);
      console.log('输入原密码:', oldpwd);

      if (!stored || oldpwd !== stored) {
        const newCount = errorCount + 1;
        sessionStorage.setItem(errorCountKey, newCount);
        if (newCount >= 5) {
          alert('🚫 您的账户已经被系统锁定，请联系客服人工处理。');
        } else {
          alert(`🚫 原始密码错误！您已错 ${newCount} 次，错误 5 次将锁定`);
        }
        return;
      }

      if (newpwd.length !== 4 || confirm.length !== 4) {
        alert('⚠️ 密码必须是 4 位数字');
        return;
      }

      if (newpwd !== confirm) {
        alert('🚫 您的安全密码和确认密码不一致');
        return;
      }

      sessionStorage.setItem(passwordKey, newpwd);
      sessionStorage.setItem(errorCountKey, '0');
      window.location.href = 'password_success.html';
    }
  </script>
</body>
</html>

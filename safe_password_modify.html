
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>修改安全密码</title>
  <link rel="stylesheet" href="style_password.css" />
</head>
<body>
  <div class="container">
    <div class="box">
      <input type="password" id="old" placeholder="原始密码" maxlength="4" />
      <input type="password" id="new1" placeholder="新密码" maxlength="4" />
      <input type="password" id="new2" placeholder="确认密码" maxlength="4" />
      <button onclick="modifyPassword()">下一步</button>
    </div>
  </div>

<script>
  function getTelegramUserId() {
    try {
      return window.Telegram?.WebApp?.initDataUnsafe?.user?.id || "anonymous";
    } catch (e) {
      return "anonymous";
    }
  }

  function modifyPassword() {
    const userId = getTelegramUserId();
    const oldpwd = document.getElementById("old").value;
    const newpwd1 = document.getElementById("new1").value;
    const newpwd2 = document.getElementById("new2").value;

    const stored = sessionStorage.getItem("userPassword_" + userId) || localStorage.getItem("userPassword_" + userId);
    console.log("当前存储密码 =", stored, "输入的旧密码 =", oldpwd);

    if (!stored || oldpwd !== stored) {
      alert("🚫 原始密码错误！");
      return;
    }

    if (!/^[0-9]{4}$/.test(newpwd1)) {
      alert("⚠️ 新密码必须是4位数字");
      return;
    }

    if (newpwd1 !== newpwd2) {
      alert("🚫 新密码与确认密码不一致");
      return;
    }

    localStorage.setItem("userPassword_" + userId, newpwd1);
    sessionStorage.setItem("userPassword_" + userId, newpwd1);
    alert("✅ 密码修改成功！");
    window.location.href = "password_success.html";
  }
</script>
</body>
</html>

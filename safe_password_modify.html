
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>ä¿®æ”¹å®‰å…¨å¯†ç </title>
  <link rel="stylesheet" href="style_password.css" />
</head>
<body>
  <div class="container">
    <div class="white-box">
      <h2 class="box-title">ä¿®æ”¹å®‰å…¨å¯†ç </h2>
      <input id="old" maxlength="4" inputmode="numeric" pattern="[0-9]*" class="input-box" placeholder="è¯·è¾“å…¥åŸå§‹å®‰å…¨å¯†ç " />
      <input id="new" maxlength="4" inputmode="numeric" pattern="[0-9]*" class="input-box" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆ4ä½æ•°å­—ï¼‰" />
      <input id="confirm" maxlength="4" inputmode="numeric" pattern="[0-9]*" class="input-box" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç " />
    </div>
    <button class="next-btn" onclick="handleSubmit()">ä¸‹ä¸€æ­¥</button>
  </div>
  <script>
    const tg = window.Telegram.WebApp || {};
    const userId = tg.initDataUnsafe?.user?.id || 'debug_user';
    const passwordKey = 'userPassword_' + userId;
    const errorCountKey = 'passwordErrorCount_' + userId;

    function handleSubmit() {
      const oldpwd = document.getElementById('old').value.trim();
      const newpwd = document.getElementById('new').value.trim();
      const confirm = document.getElementById('confirm').value.trim();

      const stored = sessionStorage.getItem(passwordKey);
      const errorCount = parseInt(sessionStorage.getItem(errorCountKey) || '0');

      console.log('ç”¨æˆ·ID:', userId);
      console.log('ä¼šè¯å­˜å‚¨å¯†ç :', stored);
      console.log('è¾“å…¥åŸå¯†ç :', oldpwd);

      if (!stored || oldpwd !== stored) {
        const newCount = errorCount + 1;
        sessionStorage.setItem(errorCountKey, newCount);
        if (newCount >= 5) {
          alert('ğŸš« æ‚¨çš„è´¦æˆ·å·²ç»è¢«ç³»ç»Ÿé”å®šï¼Œè¯·è”ç³»å®¢æœäººå·¥å¤„ç†ã€‚');
        } else {
          alert(`ğŸš« åŸå§‹å¯†ç é”™è¯¯ï¼æ‚¨å·²é”™ ${newCount} æ¬¡ï¼Œé”™è¯¯ 5 æ¬¡å°†é”å®š`);
        }
        return;
      }

      if (newpwd.length !== 4 || confirm.length !== 4) {
        alert('âš ï¸ å¯†ç å¿…é¡»æ˜¯ 4 ä½æ•°å­—');
        return;
      }

      if (newpwd !== confirm) {
        alert('ğŸš« æ‚¨çš„å®‰å…¨å¯†ç å’Œç¡®è®¤å¯†ç ä¸ä¸€è‡´');
        return;
      }

      sessionStorage.setItem(passwordKey, newpwd);
      sessionStorage.setItem(errorCountKey, '0');
      window.location.href = 'password_success.html';
    }
  </script>
</body>
</html>
